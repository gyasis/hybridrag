version: '3.8'

services:
  # =============================================================================
  # Single Instance Deployment (Unified Database)
  # =============================================================================
  # Use this for unified cross-project queries
  # Mounts parent directory and processes all .specstory folders into one DB
  # =============================================================================

  hybridrag:
    build: .
    container_name: hybridrag-main
    image: hybridrag:latest
    environment:
      # API Keys (set in .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Application settings
      - PYTHONUNBUFFERED=1
      - LIGHTRAG_WORKING_DIR=/app/lightrag_db

      # Performance tuning (optional)
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-50}
      - BATCH_SIZE=${BATCH_SIZE:-10}

    volumes:
      # Mount projects directory (read-only for safety)
      - ${HOST_PROJECTS_PATH:-/home/gyasis/Documents/code}:/data/projects:ro

      # Persistent database storage
      - ./lightrag_db:/app/lightrag_db

      # Ingestion queue (for processing state)
      - ./ingestion_queue:/app/ingestion_queue

      # Logs (optional)
      - ./logs:/app/logs

    restart: unless-stopped

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-4g}
          cpus: '${CPU_LIMIT:-2.0}'
        reservations:
          memory: 2g
          cpus: '1.0'

    # Override default command for auto-ingestion
    command: >
      bash -c "
        echo 'Starting HybridRAG container...' &&
        python hybridrag.py check-db &&
        echo 'Ready for queries. Use: docker compose exec hybridrag python hybridrag.py interactive' &&
        tail -f /dev/null
      "

    # Uncomment for interactive mode by default
    # stdin_open: true
    # tty: true


  # =============================================================================
  # Multi-Instance Deployment Examples (Isolated Databases)
  # =============================================================================
  # Uncomment sections below for separate team/project deployments
  # Each instance gets its own database for strict isolation
  # =============================================================================

  # Team A Instance
  # hybridrag-team-a:
  #   build: .
  #   container_name: hybridrag-team-a
  #   environment:
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #   volumes:
  #     - /data/team-a-projects:/data/projects:ro
  #     - ./team-a-db:/app/lightrag_db
  #     - ./team-a-queue:/app/ingestion_queue
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2g
  #         cpus: '1.0'

  # Team B Instance
  # hybridrag-team-b:
  #   build: .
  #   container_name: hybridrag-team-b
  #   environment:
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #   volumes:
  #     - /data/team-b-projects:/data/projects:ro
  #     - ./team-b-db:/app/lightrag_db
  #     - ./team-b-queue:/app/ingestion_queue
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2g
  #         cpus: '1.0'


  # =============================================================================
  # Nginx Load Balancer (Optional)
  # =============================================================================
  # Uncomment if you need HTTP API access with load balancing
  # Requires adding HTTP API endpoints to hybridrag.py
  # =============================================================================

  # nginx:
  #   image: nginx:alpine
  #   container_name: hybridrag-nginx
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - hybridrag-team-a
  #     - hybridrag-team-b
  #   restart: unless-stopped


# =============================================================================
# Volume Definitions (Optional - for named volumes)
# =============================================================================
# Uncomment if you prefer Docker-managed volumes over bind mounts

# volumes:
#   lightrag_db:
#     driver: local
#   ingestion_queue:
#     driver: local


# =============================================================================
# Network Configuration (Optional)
# =============================================================================
# Uncomment for custom networking

# networks:
#   hybridrag-net:
#     driver: bridge
