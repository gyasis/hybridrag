# HybridRAG PostgreSQL Backend with Apache AGE + pgvector
# ========================================================
# Auto-provision PostgreSQL with both AGE (graph) and pgvector extensions.
#
# Usage:
#   docker-compose -f docker-compose.postgres.yaml up -d
#
# Or use the CLI command:
#   hybridrag backend setup-docker
#
# Environment Variables:
#   POSTGRES_PASSWORD - Database password (default: hybridrag_secure_2026)
#   POSTGRES_PORT     - Host port mapping (default: 5433, since 5432 is used by OpenMetadata)
#   POSTGRES_DATA_DIR - Host path for data volume (default: Docker volume)

services:
  hybridrag-postgres:
    image: apache/age:latest
    container_name: hybridrag-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: hybridrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hybridrag_secure_2026}
      POSTGRES_DB: hybridrag
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"

    # Install pgvector extension before PostgreSQL starts
    # Apache AGE image already has the AGE extension
    entrypoint: >
      bash -c "
        apt-get update &&
        apt-get install -y --no-install-recommends postgresql-17-pgvector &&
        rm -rf /var/lib/apt/lists/* &&
        exec docker-entrypoint.sh postgres
      "

    ports:
      - "${POSTGRES_PORT:-5433}:5432"

    volumes:
      # Persistent data volume
      - hybridrag-pgdata:/var/lib/postgresql/data
      # Optional: Mount initialization scripts
      - ./init-scripts:/docker-entrypoint-initdb.d:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hybridrag -d hybridrag"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 90s  # Increased for pgvector installation

    # Memory limits - increased for 6.6GB migration
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # PostgreSQL server configuration
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=1536MB"
      - "-c"
      - "maintenance_work_mem=256MB"
      - "-c"
      - "work_mem=32MB"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "max_wal_size=2GB"
      - "-c"
      - "min_wal_size=256MB"

volumes:
  hybridrag-pgdata:
    driver: local

networks:
  default:
    name: hybridrag-network
